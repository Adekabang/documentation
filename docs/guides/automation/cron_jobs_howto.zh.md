---
title: cron - 自动化命令
author: unknown
contributors: Steven Spencer,tianci li
update:2021-12-08
---

# 在 Rocky Linux 中使用 cron 和 crontab 自动化进程

## 准备工作

* 一台运行 Rocky Linux 的机器。
* 知道如何在命令行环境下使用您喜欢的编辑器修改配置文件（本文将使用 _vi_）。

## <a name="assumptions"></a>假定

* 您已了解 bash、python 或其他脚本/编程工具的基本知识，并期望自动运行脚本。
* 您已以 root 用户身份运行，或使用 `sudo -s` 切换到 root 用户。
**（您可以以自己的用户身份在自己的目录中运行某些脚本。在这种情况下，无需切换到 root。）**
* 我们认为，你是非常酷的人。

## 简介

Linux提供了 _cron_ 系统，一个基于时间的作业调度程序，用于自动化进程。它很简单，也很强大。想让脚本或程序每天下午 5 点运行吗？设置 cron 即可。

_crontab_ 本质上是一个列表，用户可以在其中添加自己的自动化任务和作业，并且有许多可以进一步简化操作的选项。本文将探讨其中的一些选项。本文对有一定经验的用户而言是一个很好的温习，对新用户而言将系统学习 cron。

这里参考`cron`的"点"目录简要讨论`anacron`。`anacron`由`cron`运行，对于工作站和笔记本电脑等不是一直处于运行状态的机器来说非常有利，这里因为，当`cron`按照计划运行作业时，如果在调度作业时机器处于关闭状态，作业就不会运行。使用`anacron`，当机器重新开机时，作业会被重新拾起且运行，即使计划的运行时间已经过去。不过，`anacron`使用了一种更随机的方法来运行时间不准确的任务，这对于工作站与笔记本电脑来说是有意义的，但对服务器来说就没有那么有意义。例如，对于需要在特定时间运行的服务器备份等情况，这可能是个问题，所以！`cron`解决了服务器管理员的痛点。话虽如此，服务器管理员或工作站用户给或笔记本电脑用户，可以根据需要轻松混合搭配这两种方法，有关`anacron` 的更多消息，请参阅[anacron - 自动化命令](anacron.zh.md)

## <a name="starting-easy"></a>轻松入门 —— cron 点目录

包括 Rock Linux 在内的许多 Linux 发行版都内置了 `cron` "点"文件，这些文件有助于快速配置自动化进程，它们显示为 `cron` 系统根据其命名约定调用的目录。然而，它们的调用是不同的，这取决于分配给它们的进程是`cron`还是`anacron`，默认是使用`anacron`。但这可以由服务器、工作站或笔记本电脑的管理员更改。

#### <a name="for_servers"></a>对于服务器

如简介中说的那样，`cron`现在通常运行`anacron`来执行这些"点"目录中的脚本。不过，您"可能"也想在服务器上使用这些"点"目录，如果是这样的话，您可以采取两个步骤来确保这些"点"目录按照严格的时间表运行。为此，我们需要安装一个软件包并删除另一个软件包:

`dnf install cronie-noanacron`

和

`dnf remove cronie-anacron`

正如您所料，这将从服务器中删除`anacron`，并恢复到严格按照时间表在"点"目录中运行任务。这是由以下文件定义的：`/etc/cron.d/dailyjobs`，该文件具有以下内容：

```
# Run the daily, weekly, and monthly jobs if cronie-anacron is not installed
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

# run-parts
02 4 * * * root [ ! -f /etc/cron.hourly/0anacron ] && run-parts /etc/cron.daily
22 4 * * 0 root [ ! -f /etc/cron.hourly/0anacron ] && run-parts /etc/cron.weekly
42 4 1 * * root [ ! -f /etc/cron.hourly/0anacron ] && run-parts /etc/cron.monthly
```

这意味着: 

* 每天的04:02:00，在"cron.daily"中运行脚本。
* 每周星期日的04:22:00，在"cron.weekly"中运行脚本。
* 每月第一天的04:42:00，在"cron.monthly"中运行脚本。

#### <a name="for_workstations"></a>对于工作站

如果您想在工作站或笔记本电脑上的`cron`"点"目录中运行脚本，那么您无需执行任何特殊操作。只需将脚本文件复制到相关的目录中，并确保它是可执行的。以下是目录：

* `/etc/cron.hourly` -此处放置的脚本将每小时运行一次。(无论是否安装了`anacron`，都由`cron`运行)
* `/etc/cron.daily` - 此处放置的脚本将每天运行。`anacron`可以调整这些的时间。(见提示)
* `/etc/cron.weekly` - 此处放置的脚本将每7天运行一次，以最后一次运行时间的日历日为基准。(见提示)
* `/etc/cron.monthly` - 此处放置的脚本将根据上次运行时间的日历日每月运行一次。（见提示）
  
!!! tip "提示"
    它们可能在每天、每周和每月的类似（但不完全相同的）时间运行。有关更精确的运行时间，请参阅下面的 @options。

因此，只要你不介意让系统自动运行你的脚本，并允许它们在指定的时间段内运行，那么自动化任务就非常容易了。

!!! note "笔记"
    没有规则规定服务器管理员不能使用`anacron`，它的随机运行时间也是可以用来运行"点"目录中的脚本，这方面的使用例子是对时间不敏感的脚本。

## 创建自定义 cron

当然，无论出于何种原因，自动化时间都不能很好地为您工作，那么您可以创建自定义时间。本示例中，假设您以 root 用户身份执行此操作。为此，[请参见假定](##-assumptions)，键入以下内容：

`crontab -e`

这将调出 root 用户的 crontab，就像它此时存在于您选择的编辑器中一样，可能如下所示。请继续阅读以下注释，因为它包含接下来将使用的每个字段的描述：

```
# 编辑此文件以引入要由 cron 运行的任务。
#
# 一行定义一个要运行的任务
# 在一行中用不同的字段指示何时运行该任务
# 以及为该任务运行的命令
#
# 要定义时间，可以为
# 分钟（m）、小时（h）、月日（dom）、月（mon）和星期（dow）
# 提供具体值，或者在这些字段中使用"*"（表示"任何"）。
#
# 注意，将根据 cron 的系统守护程序的时间和
# 时区概念启动任务。
#
# 作业的输出（包括错误）通过电子邮件发送给
# crontab 文件所属的用户（除非重定向）。
# cron
# 例如，每周一上午 5 点运行所有用户
# 帐户的备份：
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
#
# 有关更多信息，请参见 crontab（5）和 cron（8）的手册页
#
# m h  dom mon dow   command
```

注意，这个特定的 `crontab` 文件内置了一些自己的文档，但并非总是如此。在容器或极简操作系统上修改 `crontab` 时，`crontab` 将是一个空文件，除非已经在其中放置了条目。

假设有一个备份脚本，希望在晚上 10 点运行。`crontab` 使用 24 小时制，因此应该是 22:00。假设备份脚本名为“backup”，并且当前位于 _/usr/local/sbin_ 目录中。

!!! note "笔记"
    请记住，此脚本还需要是可执行的(`chmod+x`)，`cron`才能运行它。

要添加作业，我们将执行以下操作:

`crontab -e`

 `crontab`代表"cron table"，文件的格式实际上是松散的表布局。现在在 `crontab` 中，转到文件的底部并添加新条目。如果您使用 `vi` 作为默认的系统编辑器，那么可以通过以下键来完成：

`Shift : $`

现在，您位于文件的底部，插入一行并键入简短的注释以描述条目的内容。注释是通过在行首添加“＃”来完成的：

`# 每晚 10 点备份系统`

现在按回车键。您应该仍然处于插入模式，因此下一步是添加条目。如空注释的`crontab`（上面） 所示，**m** 表示分钟，**h** 表示小时，**dom** 表示日，**mon** 表示月，**dow** 表示星期。

要在每晚 10:00 运行备份脚本，条目如下所示：

`00  22  *  *  *   /usr/local/sbin/backup`

这表示在每月、每周和每日的晚上 10 点运行脚本。显然，这是一个非常简单的示例，当您需要详细说明时，情况可能会变得非常复杂。

### crontab 的 @选项

另一种在严格计划的时间(即日、周、月、年等)运行作业的方法，就是使用 @选项，它提供使用更自然的时间的能力。@选项包括：

* `@hourly` 在每天每小时的 0 分钟后运行脚本。(这也正是将你的脚本放在`/etc/cron.hourly`中的结果）
* `@daily` 在每天午夜运行脚本。
* `@weekly` 在每周的周日午夜运行脚本。
* `@monthly` 在每个月的第一天午夜运行脚本。
* `@yearly` 在每年 1 月 1 日午夜运行脚本。
* `@reboot` 仅在系统启动时运行脚本。

!!! note "笔记"
    使用这些`crontab`条目将绕过`anacron`系统，无论是否安装了`anacron`，都会恢复为`crond.service`。

对于备份脚本示例，如果使用 @daily 选项在午夜运行备份脚本，则该条目将如下所示：

`@daily  /usr/local/sbin/backup`

### 更复杂的选项

到目前为止，所讨论的内容都是非常简单的选项，但是更复杂的定时任务又该如何完成呢？假设要在一天中每 10 分钟运行一次备份脚本（可能不切实际，但是，仅是一个示例！）。为此，将编写以下内容：

`*/10  *   *   *   *   /usr/local/sbin/backup`

如果您只想在星期一、星期三和星期五的每 10 分钟运行一次备份呢？:

`*/10  *   *   *   1,3,5   /usr/local/sbin/backup`

除了星期六和星期日，每天每 10 分钟备份一次又如何？

`*/10  *   *   *   1-5   /usr/local/sbin/backup`

在表中，逗号用于指定字段中的单个条目，而破折号用于指定字段中的值范围。它可以在任何字段中使用，也可以同时在多个字段中使用。如您所见，情况会变得相当复杂。

在确定何时运行脚本时，您需要花费时间并进行规划，尤其是在条件复杂的情况下。

## 总结

对于 Rocky Linux 桌面用户或系统管理员而言，cron/crontab 系统是一个非常强大的工具。它可以让您自动执行任务和脚本，这样您就不必记住手动运行它们。这里提供了更多的示例：

* 对于不是一天 24 小时运行的机器，探索 [anacron - 自动化命令](anacron.zh.md)。
* 有关`cron`进程的简明描述，请查看[cronie - 定时任务](cronie.zh.md)

虽然基础知识很简单，但实际任务可能很复杂。有关 crontab 的更多信息，请访问 [crontab 手册页](https://man7.org/linux/man-pages/man5/crontab.5.html)。您还可以简单地在网上搜索"crontab"，它将为您提供大量搜索结果，帮助您微调 `crontab` 表达式。
